# è¿­ä»£121 - æ€§èƒ½ä¼˜åŒ–åˆ†ææŠ¥å‘Šï¼ˆç¬¬äºŒè½®ï¼‰

## èƒŒæ™¯

åŸºäºè¿­ä»£120çš„ä¼˜åŒ–åï¼Œé‡æ–°å¯¹æ¯” master åˆ†æ”¯ä¸ development åˆ†æ”¯çš„æ€§èƒ½å·®å¼‚ï¼Œè¯†åˆ«å‰©ä½™çƒ­ç‚¹å¹¶ç»™å‡ºè¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®ã€‚

### å¯¹æ¯”åŸºå‡†ï¼ˆæœ€æ–° 2026-01-17ï¼‰
- **master**: `logs/performance_profile_master_20260117_093200.log` (**563.25s**)
- **development**: `logs/performance_profile_development_20260117_093551.log` (**554.07s**)
- **ğŸ‰ å½“å‰çŠ¶æ€**: development æ¯” master **å¿« 1.6%** (-9.18s)

> **é‡å¤§è¿›å±•**: ç»è¿‡å‰æœŸä¼˜åŒ–ï¼Œdevelopment åˆ†æ”¯æ€§èƒ½å·²è¶…è¶Š master åˆ†æ”¯ï¼
> 
> **æµ‹è¯•çŠ¶æ€**: âœ… æ‰€æœ‰ 478 ä¸ªæµ‹è¯•é€šè¿‡ï¼Œ`scripts/optimize_code.sh` éªŒè¯é€šè¿‡

### å†å²å¯¹æ¯”ï¼ˆæ—§æ•°æ®å‚è€ƒï¼‰
- **master (æ—§)**: `logs/performance_profile_master_20260116_214606.log` (511.51s)
- **development (æ—§)**: `logs/performance_profile_development_20260117_080256.log` (658.96s)
- **æ€§èƒ½å·®è· (æ—§)**: +147.45s (+28.8%)

---

## å…³é”®å‘ç°

### 1. å†…ç½®å‡½æ•°è°ƒç”¨é‡å‰§å¢

| å‡½æ•° | master è°ƒç”¨æ¬¡æ•° | development è°ƒç”¨æ¬¡æ•° | å¢å¹… |
|------|-----------------|---------------------|------|
| `builtins.len` | 34.84M | 74.46M | +114% |
| `builtins.isinstance` | 45.38M | 104.29M | +130% |
| `builtins.hasattr` | N/A | 38.48M | æ–°å¢çƒ­ç‚¹ |
| `builtins.any` | 8.76M | 9.32M | +6% |
| `builtins.getattr` | 40.21M | 61.92M | +54% |

**åˆ†æ**: development åˆ†æ”¯çš„ä»£ç é‡æ„å¼•å…¥äº†å¤§é‡é¢å¤–çš„ç±»å‹æ£€æŸ¥å’Œå±æ€§æ¢æµ‹è°ƒç”¨ï¼Œè¿™æ˜¯æ€§èƒ½ä¸‹é™çš„ä¸»è¦åŸå› ä¹‹ä¸€ã€‚

### 2. LineSeries/LineBuffer forward è°ƒç”¨å¼€é”€

| å‡½æ•° | master cumtime | development cumtime | å¢å¹… |
|------|----------------|---------------------|------|
| `lineseries.py:forward` | 35.77s (4.97M calls) | 33.52s + 32.36s (2.1M calls Ã— 2) | ç»“æ„å˜åŒ– |
| `linebuffer.py:forward` | 29.06s (17.27M calls) | 28.95s (10.73M calls) | ç±»ä¼¼ |
| `lineseries.py:__setattr__` | N/A | 16.46s (21.27M calls) | æ–°å¢çƒ­ç‚¹ |
| `lineseries.py:__len__` | 22.08s (16.02M calls) | 7.61s (7.37M calls) | -65% âœ“ |

**åˆ†æ**: `LineSeries.__setattr__` æ˜¯æ–°çƒ­ç‚¹ï¼Œè¯´æ˜å±æ€§è®¾ç½®é€»è¾‘å¼•å…¥äº†é¢å¤–å¼€é”€ã€‚

### 3. æŒ‡æ ‡è®¡ç®—æ•ˆç‡

| å‡½æ•° | master | development | è¯´æ˜ |
|------|--------|-------------|------|
| `bollinger.py:once` | N/A | 22.07s (12 calls) | O(N*period) åµŒå¥—å¾ªç¯ |
| `sma.py:once` | N/A | 18.60s (210 calls) | æ¯æ¬¡è°ƒç”¨ genexpr |
| `sma.py:<genexpr>` | N/A | 14.00s (27.33M calls) | SMA å†…å¾ªç¯ |

**åˆ†æ**: æŒ‡æ ‡çš„ `once()` æ–¹æ³•ä»ä½¿ç”¨ä½æ•ˆå®ç°ï¼Œç‰¹åˆ«æ˜¯ Bollinger Bands å’Œ SMAã€‚

### 4. å‚æ•°ç³»ç»Ÿå¼€é”€

| å‡½æ•° | è°ƒç”¨æ¬¡æ•° | tottime | è¯´æ˜ |
|------|----------|---------|------|
| `parameters.py:get_param` | 7.41M | 3.81s | ä»æœ‰å¤§é‡è°ƒç”¨ |
| `parameters.py:283(get)` | 9.65M | 2.27s | ParameterManager.get |
| `metabase.py:1581(p)` | 16.25M | 4.05s | å±æ€§ä»£ç† |

**åˆ†æ**: è¿­ä»£120 çš„æœ¬åœ°ç¼“å­˜æœ‰æ•ˆï¼Œä½†å…¶ä»–çƒ­è·¯å¾„ä»é¢‘ç¹è°ƒç”¨å‚æ•°ç³»ç»Ÿã€‚

---

## ä¼˜åŒ–å»ºè®®

### å»ºè®® Aï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼šä¼˜åŒ– LineSeries.__setattr__ 

**çƒ­ç‚¹**: `lineseries.py:1344(__setattr__)` - 21.27M æ¬¡è°ƒç”¨ï¼Œ16.46s ç´¯è®¡æ—¶é—´

**é—®é¢˜**: å½“å‰å®ç°å¯¹æ¯æ¬¡å±æ€§è®¾ç½®éƒ½æ‰§è¡Œå¤šé‡ç±»å‹æ£€æŸ¥å’Œ `hasattr`/`isinstance` è°ƒç”¨ã€‚

**è½åœ°æ–¹å‘**:
```python
# å½“å‰å®ç°ï¼ˆä¼ªä»£ç ï¼‰:
def __setattr__(self, name, value):
    if name and name[0] == "_":  # OK - fast path
        object.__setattr__(self, name, value)
        return
    # ... å¤šé‡ isinstance/hasattr æ£€æŸ¥ ...

# ä¼˜åŒ–å»ºè®®:
# 1. æ‰©å¤§å¿«é€Ÿè·¯å¾„è¦†ç›–èŒƒå›´
# 2. ä½¿ç”¨ type(value) æ›¿ä»£ isinstance() è¿›è¡Œç®€å•ç±»å‹æ£€æŸ¥
# 3. ç¼“å­˜å¸¸ç”¨ç±»å‹é›†åˆï¼Œé¿å…é‡å¤åˆ›å»º
```

### å»ºè®® Bï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼šå‡å°‘ builtins.len/isinstance/hasattr è°ƒç”¨

**çƒ­ç‚¹**: 
- `len()`: 74.46M æ¬¡ï¼Œ18.05s
- `isinstance()`: 104.29M æ¬¡ï¼Œ14.21s
- `hasattr()`: 38.48M æ¬¡ï¼Œ8.46s

**è½åœ°æ–¹å‘**:
1. **å®¡æŸ¥ LineBuffer/LineSeries æ–¹æ³•**ï¼Œè¯†åˆ«å¾ªç¯å†…çš„ `len()` è°ƒç”¨ï¼Œæå–åˆ°å¾ªç¯å¤–
2. **æ›¿æ¢ `isinstance(x, float)`** ä¸º `type(x) is float`ï¼ˆå¯¹å·²çŸ¥ç±»å‹æ›´å¿«ï¼‰
3. **æ›¿æ¢ `hasattr(obj, attr)`** ä¸º `getattr(obj, attr, None) is not None` æˆ– try/except
4. **ç¼“å­˜ `len(self)` ç»“æœ** åœ¨è¿­ä»£å™¨çš„çƒ­è·¯å¾„ä¸­

**ç¤ºä¾‹ä¿®æ”¹**:
```python
# å‰:
for i in range(len(self)):
    if isinstance(val, float) and math.isnan(val):
        ...

# å:
self_len = len(self)
float_type = float
isnan = math.isnan
for i in range(self_len):
    val = ...
    if type(val) is float_type and isnan(val):
        ...
```

### å»ºè®® Cï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰ï¼šä¼˜åŒ– SMA.once() æ»‘åŠ¨çª—å£

**çƒ­ç‚¹**: `sma.py:once` + `sma.py:<genexpr>` åˆè®¡ ~32.6s

**é—®é¢˜**: å½“å‰æ¯ä¸ªæ—¶é—´æ­¥éƒ½é‡æ–°è®¡ç®— `sum(src[i-period+1:i+1])` ç”Ÿæˆå™¨è¡¨è¾¾å¼ã€‚

**è½åœ°æ–¹å‘**:
```python
def once(self, start, end):
    src = self.data.array
    dst = self.lines[0].array
    period = self.params.period
    
    # O(N) æ»‘åŠ¨çª—å£
    window_sum = sum(src[start:start+period])
    dst[start + period - 1] = window_sum / period
    
    for i in range(start + period, end):
        window_sum += src[i] - src[i - period]
        dst[i] = window_sum / period
```

### å»ºè®® Dï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰ï¼šä¼˜åŒ– BollingerBands.once() æ»‘åŠ¨çª—å£

**çƒ­ç‚¹**: `bollinger.py:once` - 22.07s (12 calls)ï¼Œå•æ¬¡è°ƒç”¨ 1.84s

**é—®é¢˜**: å½“å‰ä½¿ç”¨ O(N*period) åµŒå¥—å¾ªç¯è®¡ç®—æ ‡å‡†å·®ã€‚

**è½åœ°æ–¹å‘**ï¼ˆæ¢å¤è¿­ä»£120è¢«å›é€€çš„ä¼˜åŒ–ï¼‰:
```python
def once(self, start, end):
    # ä½¿ç”¨ rolling sum å’Œ rolling sum_sq å®ç° O(N) è®¡ç®—
    # éœ€è¦ç¡®ä¿æ•°å€¼ç¨³å®šæ€§ï¼Œé¿å…æµ®ç‚¹è¯¯å·®ç´¯ç§¯
    pass
```

**æ³¨æ„**: æ­¤ä¼˜åŒ–åœ¨è¿­ä»£120ä¸­å®ç°åè¢«ç”¨æˆ·å›é€€ï¼Œéœ€ç¡®è®¤åŸå› åå†³å®šæ˜¯å¦é‡æ–°å¼•å…¥ã€‚

### å»ºè®® Eï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼šLineBuffer.forward() å¾®ä¼˜åŒ–

**çƒ­ç‚¹**: `linebuffer.py:599(forward)` - 10.73M æ¬¡ï¼Œ18.33s

**è½åœ°æ–¹å‘**:
1. å‡å°‘æ–¹æ³•å†…çš„å±æ€§è®¿é—®ï¼Œç¼“å­˜ `self.array` åˆ°å±€éƒ¨å˜é‡
2. è€ƒè™‘ä½¿ç”¨ `__slots__` å‡å°‘å®ä¾‹å­—å…¸å¼€é”€
3. å†…è”ç®€å•é€»è¾‘ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€

### å»ºè®® Fï¼ˆè¯„ä¼°é¡¹ï¼‰ï¼šautodict.__getattr__/__setattr__ ä¼˜åŒ–

**çƒ­ç‚¹**: 
- `autodict.py:178(__getattr__)`: 8.76M æ¬¡ï¼Œ2.95s
- `autodict.py:184(__setattr__)`: 4.75M æ¬¡ï¼Œ1.89s

**è½åœ°æ–¹å‘**:
- å‡å°‘ AutoDict çš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ–æä¾›æ›´è½»é‡çš„æ›¿ä»£å®ç°

---

## éªŒè¯æ–¹æ¡ˆ

### å®‰è£…éªŒè¯
```bash
pip install -U .
```

### æ ¼å¼åŒ–/è´¨é‡æ£€æŸ¥
```bash
bash scripts/optimize_code.sh
```

### å•å…ƒæµ‹è¯•
```bash
pytest tests -n 12
```

### æ€§èƒ½å¤æµ‹
```bash
python scripts/profile_performance.py --processes 12
```

### å¯¹æ¯”åŸºå‡†ï¼ˆæœ€æ–°ï¼‰
- master: `logs/performance_profile_master_20260117_093200.log` (**563.25s**)
- development: `logs/performance_profile_development_20260117_093551.log` (**554.07s**)
- **å½“å‰çŠ¶æ€**: âœ… development å·²æ¯” master å¿« 1.6%
- **æµ‹è¯•çŠ¶æ€**: âœ… 478/478 æµ‹è¯•é€šè¿‡

---

## ä¼˜å…ˆçº§æ’åºï¼ˆæ›´æ–°ï¼‰

| ä¼˜å…ˆçº§ | å»ºè®® | é¢„æœŸæ”¶ç›Š | å®ç°éš¾åº¦ | çŠ¶æ€ |
|--------|------|----------|----------|------|
| âœ… å®Œæˆ | æ ¸å¿ƒä¼˜åŒ–ï¼ˆè¿­ä»£120ï¼‰ | ~150s | - | å·²å®Œæˆ |
| ğŸŸ¡ å¯é€‰ | A - LineSeries.__setattr__ ä¼˜åŒ– | 5-10s | ä¸­ | å¾…è¯„ä¼° |
| ğŸŸ¡ å¯é€‰ | B - å‡å°‘ len/isinstance/hasattr | 5-10s | ä½-ä¸­ | å¾…è¯„ä¼° |
| ğŸŸ¡ å¯é€‰ | C - SMA.once() æ»‘åŠ¨çª—å£ | 5-8s | ä¸­ | å¾…è¯„ä¼°ï¼ˆéœ€ç¡®ä¿æµ‹è¯•å…¼å®¹ï¼‰ |
| ğŸŸ¡ å¯é€‰ | D - BollingerBands.once() æ»‘åŠ¨çª—å£ | 5-8s | ä¸­ | å¾…è¯„ä¼°ï¼ˆéœ€ç¡®ä¿æµ‹è¯•å…¼å®¹ï¼‰ |
| ğŸŸ¢ ä½ | E - LineBuffer.forward() å¾®ä¼˜åŒ– | 2-3s | ä½ | å¯é€‰ |
| ğŸŸ¢ ä½ | F - autodict ä¼˜åŒ– | 1-2s | ä½ | å¯é€‰ |

**å½“å‰æˆæœ**: development æ€§èƒ½å·²è¶…è¶Š master **1.6%**ï¼Œæ ¸å¿ƒä¼˜åŒ–ç›®æ ‡å·²è¾¾æˆï¼

---

## ç»“è®º

ç»è¿‡è¿­ä»£120çš„ä¼˜åŒ–å·¥ä½œï¼Œdevelopment åˆ†æ”¯æ€§èƒ½å·²ç»è¶…è¶Š master åˆ†æ”¯ï¼š
- **æ€§èƒ½æå‡**: ä» +28.8% æ…¢ â†’ **å¿« 1.6%**
- **æµ‹è¯•é€šè¿‡ç‡**: 478/478 (100%)
- **ä»£ç è´¨é‡**: `scripts/optimize_code.sh` éªŒè¯é€šè¿‡

åç»­ä¼˜åŒ–ï¼ˆå»ºè®® A-Fï¼‰ä¸º**å¯é€‰é¡¹**ï¼Œå¯åœ¨ç¡®ä¿æµ‹è¯•å…¼å®¹çš„å‰æä¸‹é€æ­¥å®æ–½ã€‚
