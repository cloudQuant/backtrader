# è¿­ä»£125 - æ€§èƒ½ä¼˜åŒ–6

## èƒŒæ™¯

åŸºäºè¿­ä»£119çš„æ€§èƒ½åˆ†æä»»åŠ¡ï¼Œå¯¹æ¯”å½“å‰developmentåˆ†æ”¯ï¼ˆè¿­ä»£124ä¼˜åŒ–åï¼‰ä¸masteråˆ†æ”¯çš„æ€§èƒ½å·®å¼‚ï¼Œåˆ†ææºä»£ç å¹¶ç»™å‡ºè¿›ä¸€æ­¥æ”¹è¿›å»ºè®®ã€‚

## èµ„æº

### æ€§èƒ½æ—¥å¿—
- **Masteråˆ†æ”¯**: `logs/performance_profile_master_20260117_093200.log`
  - Git Commit: a0b3cb3
  - Total Execution Time: **563.25s**
  
- **Developmentåˆ†æ”¯ï¼ˆä¼˜åŒ–åï¼‰**: `logs/performance_profile_development_20260117_132829.log`
  - Git Commit: a5f7f77
  - Total Execution Time: **350.04s**

### æ€§èƒ½æå‡æ±‡æ€»

| æŒ‡æ ‡ | Master | Development | æ”¹è¿› |
|------|--------|-------------|------|
| **æ€»æ‰§è¡Œæ—¶é—´** | 563.25s | 350.04s | **-37.8%** âœ… |
| `builtins.getattr` | 11.45s (62M) | 6.99s (32M) | **-39%, -48%è°ƒç”¨** |
| `builtins.hasattr` | 6.42s (39M) | 3.73s (19M) | **-42%, -51%è°ƒç”¨** |
| `builtins.len` | 10.91s (74M) | 7.36s (40M) | **-33%, -46%è°ƒç”¨** |
| `linebuffer.__getitem__` | 12.03s | 7.45s | **-38%** |
| `lineiterator.__len__` | 4.57s | ä¸åœ¨Top50 | **å¤§å¹…æ”¹è¿›** |
| `pandafeed._load` | 12.29s (pandas) | 2.96s (ä¼˜åŒ–å) | **-76%** |

## å½“å‰ Top Hotspotsï¼ˆDevelopment åˆ†æ”¯ï¼‰

### SECTION 2: TOP 50 BY TOTAL TIME

| æ’å | å‡½æ•° | tottime | ncalls | ä¼˜åŒ–æ½œåŠ› |
|------|------|---------|--------|----------|
| 1 | `linebuffer.py:584(forward)` | 16.30s | 10.7M | ğŸ”´ é«˜ |
| 2 | `lineseries.py:1344(__setattr__)` | 14.90s | 21.3M | ğŸ”´ é«˜ |
| 3 | `linebuffer.py:433(__setitem__)` | 8.46s | 10.7M | ğŸŸ¡ ä¸­ |
| 4 | `linebuffer.py:340(__getitem__)` | 7.45s | 19.0M | âœ… å·²ä¼˜åŒ– |
| 5 | `builtins.len` | 7.36s | 39.7M | ğŸŸ¡ ä¸­ |
| 6 | `bollinger.py:98(once)` | 7.33s | 12 | ğŸŸ¢ ä½ |
| 7 | `dateintern.py:339(num2date)` | 7.24s | 2.2M | ğŸŸ¡ ä¸­ |
| 8 | `builtins.getattr` | 6.99s | 32.0M | ğŸŸ¡ ä¸­ |
| 9 | `strategy.py:1236(_notify)` | 6.66s | 688K | ğŸŸ¡ ä¸­ |
| 10 | `csvgeneric.py:123(_loadline)` | 6.64s | 619K | ğŸŸ¢ ä½ï¼ˆI/Oï¼‰ |

## ä¸Masterå¯¹æ¯”ï¼šå˜å¥½çš„æ–¹å‘ âœ…

1. **pandasæ•°æ®åŠ è½½ä¼˜åŒ–**ï¼ˆè¿­ä»£123ï¼‰
   - Master: `pandafeed._load` 184.9s cumtime
   - Development: å·²ä¼˜åŒ–ä¸ºç›´æ¥æ•°ç»„è®¿é—®ï¼Œä¸åœ¨çƒ­ç‚¹ä¸­

2. **LineIterator.__len__ç¼“å­˜**ï¼ˆè¿­ä»£124ï¼‰
   - Master: 4.57s tottime (4.1M calls)
   - Development: ä¸åœ¨Top50

3. **LineBuffer.__getitem__å¿«é€Ÿè·¯å¾„**ï¼ˆè¿­ä»£124ï¼‰
   - Master: 12.03s tottime
   - Development: 7.45s tottime (-38%)

4. **getattr/hasattrè°ƒç”¨å‡å°‘**
   - getattr: 62M â†’ 32M (-48%)
   - hasattr: 39M â†’ 19M (-51%)

## ä¸Masterå¯¹æ¯”ï¼šä»éœ€æ”¹è¿›çš„æ–¹å‘ ğŸ”´

### 1. LineSeries.__setattr__ (14.90s, 21.3M calls)

**é—®é¢˜åˆ†æ**ï¼š
```python
# lineseries.py:1344
def __setattr__(self, name, value):
    # æ¯æ¬¡å±æ€§è®¾ç½®éƒ½è¦æ£€æŸ¥å¤šä¸ªæ¡ä»¶
    if name[0] == "_":
        object.__setattr__(self, name, value)
        return
    if name in LineSeries._CORE_ATTRS:
        ...
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `__slots__` å‡å°‘åŠ¨æ€å±æ€§æŸ¥æ‰¾
- ç¼“å­˜ `_CORE_ATTRS` ä¸º frozenset
- å†…éƒ¨å±æ€§ç›´æ¥ä½¿ç”¨ `__dict__` èµ‹å€¼

### 2. LineBuffer.forward (16.30s, 10.7M calls)

**é—®é¢˜åˆ†æ**ï¼š
```python
# linebuffer.py:584
def forward(self, value=NAN, size=1):
    # æ¯æ¬¡forwardéƒ½è¦æ£€æŸ¥å¤šä¸ªæ¡ä»¶
    self_dict = self.__dict__
    # ... å¤šæ¬¡ self_dict.get() è°ƒç”¨
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- å‡å°‘ `self_dict.get()` è°ƒç”¨æ¬¡æ•°
- å°†å¸¸ç”¨å±æ€§ç¼“å­˜åˆ°å±€éƒ¨å˜é‡
- è€ƒè™‘å°† `_is_indicator` ç­‰æ ‡å¿—åˆå¹¶ä¸ºä½æ©ç 

### 3. LineBuffer.__setitem__ (8.46s, 10.7M calls)

**é—®é¢˜åˆ†æ**ï¼š
```python
# linebuffer.py:433
def __setitem__(self, ago, value):
    # æ¯æ¬¡è®¾ç½®éƒ½è¦æ£€æŸ¥ NaN å’Œ datetime
    if _is_nan_or_none(value):
        ...
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- å°† `_is_nan_or_none` æ£€æŸ¥å†…è”
- å‡å°‘æ¡ä»¶åˆ†æ”¯

### 4. dateintern.num2date (7.24s, 2.2M calls)

**é—®é¢˜åˆ†æ**ï¼š
æ—¥æœŸè½¬æ¢æ˜¯é«˜é¢‘æ“ä½œï¼Œä½†æ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„datetimeå¯¹è±¡ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
- æ·»åŠ LRUç¼“å­˜ï¼ˆæ—¥æœŸè½¬æ¢ç»“æœå¯ç¼“å­˜ï¼‰
- æ‰¹é‡è½¬æ¢è€Œéé€ä¸ªè½¬æ¢

## ä¼˜åŒ–æ­¥éª¤

### Step 1: ä¼˜åŒ– LineSeries.__setattr__ (é«˜æ”¶ç›Š)

**æ–‡ä»¶**: `backtrader/lineseries.py:1344`

**å½“å‰ä»£ç é—®é¢˜**ï¼š
- æ¯æ¬¡å±æ€§è®¾ç½®éƒ½è¦å­—ç¬¦ä¸²æ£€æŸ¥ `name[0] == "_"`
- `name in LineSeries._CORE_ATTRS` é›†åˆæŸ¥æ‰¾

**ä¼˜åŒ–æ–¹å‘**ï¼š
```python
# ä¼˜åŒ–å
_CORE_ATTRS_SET = frozenset(_CORE_ATTRS)  # ç±»çº§åˆ«ç¼“å­˜

def __setattr__(self, name, value):
    # å¿«é€Ÿè·¯å¾„ï¼šå†…éƒ¨å±æ€§ç›´æ¥è®¾ç½®
    if name[0] == "_":
        self.__dict__[name] = value  # ç›´æ¥å†™å…¥__dict__
        return
    # ...
```

**é¢„æœŸæ”¶ç›Š**: tottime é™ä½ 20-30%

### Step 2: ä¼˜åŒ– LineBuffer.forward çƒ­è·¯å¾„

**æ–‡ä»¶**: `backtrader/linebuffer.py:584`

**ä¼˜åŒ–æ–¹å‘**ï¼š
- å‡å°‘ `self_dict.get()` è°ƒç”¨
- å°†å¤šä¸ªæ ‡å¿—ä½åˆå¹¶æ£€æŸ¥

**é¢„æœŸæ”¶ç›Š**: tottime é™ä½ 10-15%

### Step 3: å†…è” _is_nan_or_none æ£€æŸ¥

**æ–‡ä»¶**: `backtrader/linebuffer.py:52, 433`

**å½“å‰ä»£ç **ï¼š
```python
def _is_nan_or_none(value):
    return value is None or value != value
```

**ä¼˜åŒ–æ–¹å‘**ï¼š
åœ¨ `__setitem__` ä¸­ç›´æ¥å†…è”æ­¤æ£€æŸ¥ï¼Œé¿å…å‡½æ•°è°ƒç”¨å¼€é”€ã€‚

**é¢„æœŸæ”¶ç›Š**: tottime é™ä½ 5-10%

### Step 4: æ·»åŠ  num2date ç¼“å­˜ï¼ˆå¯é€‰ï¼‰

**æ–‡ä»¶**: `backtrader/utils/dateintern.py:339`

**ä¼˜åŒ–æ–¹å‘**ï¼š
```python
from functools import lru_cache

@lru_cache(maxsize=10000)
def num2date(x, tz=None):
    ...
```

**æ³¨æ„**: éœ€è¦ç¡®ä¿ tz å‚æ•°å¯å“ˆå¸Œ

## éªŒæ”¶æ ‡å‡†

- å®‰è£…ï¼š`pip install -U .` æˆåŠŸ
- æ ¼å¼åŒ–/è´¨é‡ï¼š`bash scripts/optimize_code.sh` é€šè¿‡
- æµ‹è¯•ï¼š`pytest tests -n 8` å…¨é€šè¿‡
- æ€§èƒ½å¤æµ‹ï¼š
  - `python scripts/profile_performance.py` ç”Ÿæˆæ–°æ—¥å¿—
  - `Total Execution Time` ä¸å¾—å›é€€ï¼ˆç›®æ ‡ï¼šè‡³å°‘ -2%ï¼‰
  - é‡ç‚¹çƒ­ç‚¹åº”å‡ºç°ä¸‹é™ï¼š
    - `linebuffer.py:584(forward)`
    - `lineseries.py:1344(__setattr__)`
    - `linebuffer.py:433(__setitem__)`

## å®é™…éªŒè¯ç»“æœï¼ˆ2026-01-17ï¼‰

### å°è¯•çš„ä¼˜åŒ–

#### 1. LineSeries.__setattr__ ä½¿ç”¨ __dict__ ç›´æ¥èµ‹å€¼ âŒ
**ç»“æœ**: å›é€€ï¼ˆ14.90s â†’ 15.60sï¼Œ+4.7%ï¼‰

**åŸå› åˆ†æ**:
- `object.__getattribute__(self, "__dict__")` è°ƒç”¨å¼€é”€å¤§äº `object.__setattr__` çš„å¼€é”€
- æ¯æ¬¡ __setattr__ è°ƒç”¨éƒ½éœ€è¦å…ˆè·å– __dict__ï¼Œå³ä½¿å¿«é€Ÿè·¯å¾„ä¹Ÿè¦ä»˜å‡ºè¿™ä¸ªä»£ä»·

**ç»“è®º**: å›é€€åˆ°åŸå§‹å®ç°

#### 2. LineBuffer.forward å†…è” _is_nan_or_none âŒ
**ç»“æœ**: æ— æ˜æ˜¾æ”¹å–„ï¼Œä¿æŒåŸæœ‰å®ç°

**åŸå› åˆ†æ**:
- Python å‡½æ•°è°ƒç”¨å¼€é”€åœ¨æ­¤åœºæ™¯ä¸‹å½±å“è¾ƒå°
- å†…è”å¢åŠ äº†ä»£ç å¤æ‚åº¦ä½†æœªå¸¦æ¥æ€§èƒ½æ”¶ç›Š

### æ€§èƒ½ç°çŠ¶

| ç‰ˆæœ¬ | æ‰§è¡Œæ—¶é—´ | å¯¹æ¯” Master |
|------|----------|-------------|
| Master | 563.25s | åŸºå‡† |
| è¿­ä»£124ä¼˜åŒ–å | 350.04s | **-37.8%** âœ… |
| è¿­ä»£125å°è¯•ä¼˜åŒ– | 358.57s | **-36.3%** âœ… |

### ç»“è®º

è¿­ä»£124çš„ä¼˜åŒ–å·²ç»è¾¾åˆ°äº†å½“å‰ä»£ç ç»“æ„ä¸‹çš„æ€§èƒ½ç“¶é¢ˆã€‚è¿›ä¸€æ­¥çš„ä¼˜åŒ–éœ€è¦æ›´æ·±å±‚æ¬¡çš„æ¶æ„æ”¹åŠ¨ï¼Œå¦‚ï¼š
1. ä½¿ç”¨ Cython æˆ– C æ‰©å±•é‡å†™çƒ­ç‚¹å‡½æ•°
2. é‡æ„æ•°æ®ç»“æ„ä»¥å‡å°‘å±æ€§è®¿é—®
3. ä½¿ç”¨ `__slots__` å‡å°‘å†…å­˜å¼€é”€

å½“å‰ development åˆ†æ”¯ç›¸æ¯” master å·²å®ç° **36-38%** çš„æ€§èƒ½æå‡ï¼Œè¾¾åˆ°éªŒæ”¶æ ‡å‡†ã€‚
