# 迭代128 - 性能优化9

## 背景

基于 `performance_profile_development_20260117_143402.log` 分析，当前总执行时间 **328.78秒**。

## 性能分析

### 主要热点函数 (按tottime排序)

| 排名 | 函数 | tottime | 调用次数 | per call |
|------|------|---------|----------|----------|
| 1 | `lineseries.__setattr__()` | 14.01s | 21.3M | 0.66μs |
| 2 | `linebuffer.forward()` | 11.27s | 10.7M | 1.05μs |
| 3 | `linebuffer.__setitem__()` | 8.46s | 10.7M | 0.79μs |
| 4 | `builtins.len` | 7.51s | 38.7M | 0.19μs |
| 5 | `linebuffer.__getitem__()` | 7.46s | 19M | 0.39μs |
| 6 | `bollinger.once()` | 7.35s | 12 | 612ms |
| 7 | `csvgeneric._loadline()` | 6.61s | 619K | 10.7μs |
| 8 | `linebuffer.advance()` | 6.08s | 9.1M | 0.67μs |
| 9 | `set_idx` | 5.34s | 23.3M | 0.23μs |
| 10 | `bbroker.next()` | 5.07s | 688K | 7.36μs |

### 可优化函数

| 函数 | tottime | 调用次数 | 优化方向 |
|------|---------|----------|----------|
| `csvgeneric._loadline()` | 6.61s | 619K | 减少字符串操作 |
| `bbroker._get_value()` | 4.32s | 711K | 缓存计算结果 |
| `linebuffer.datetime()` | 3.97s | 2.5M | 优化日期访问 |
| `analyzer._notify_fund()` | 2.06s | 3.1M | 简化通知逻辑 |
| `analyzer._notify_cashvalue()` | 1.96s | 3.1M | 简化通知逻辑 |

## 优化建议

### Phase 1: 低风险优化

#### 1.1 `csvgeneric._loadline()` - 减少字符串操作

**问题**: 每次加载行时进行大量字符串操作和类型转换

**优化方案**: 预编译正则表达式，减少临时对象创建

#### 1.2 `linebuffer.datetime()` - 优化日期访问

**问题**: 每次访问都进行 NaN 检查和日期转换

**优化方案**: 添加快速路径，避免不必要的检查

#### 1.3 `analyzer._notify_fund/cashvalue` - 简化通知

**问题**: 每次通知都有多重方法调用

**优化方案**: 合并通知逻辑，减少方法调用

### Phase 2: 中等风险优化

#### 2.1 `bbroker._get_value()` - 缓存计算

**问题**: 每次获取值都重新计算

**优化方案**: 缓存最近计算结果

## 测试验证

每次优化后需要运行:
```bash
pip install -U . && pytest tests -n 8 -q --tb=no
```

## 实施记录

| 日期 | 优化项 | 状态 | 效果 |
|------|--------|------|------|
| | | | |
