# Backtrader Remove-Metaprogramming åˆ†æ”¯æ€§èƒ½é—®é¢˜æ·±åº¦åˆ†æ

## ğŸ” å‘ç°çš„ä¸¥é‡æ€§èƒ½é—®é¢˜

**åˆ†ææ—¶é—´**: 2025-10-26  
**åˆ†æ”¯**: remove-metaprogramming  
**çŠ¶æ€**: ğŸš¨ **å‘ç°å¤šä¸ªä¸¥é‡æ€§èƒ½ç“¶é¢ˆ**

---

## ğŸš¨ å…³é”®æ€§èƒ½é—®é¢˜ #1: Strategy.__init__ çš„ç¾éš¾æ€§æœç´¢é€»è¾‘

### é—®é¢˜ä½ç½®
`backtrader/strategy.py` ç¬¬ 145-231 è¡Œ

### é—®é¢˜æè¿°

Strategy çš„ `__init__` æ–¹æ³•åŒ…å«äº† **ä¸‰å±‚åµŒå¥—çš„æš´åŠ›æœç´¢**ï¼Œè¯•å›¾å¯»æ‰¾æ•°æ®æºï¼š

#### Method 1: éå† cerebro çš„æ‰€æœ‰å±æ€§ï¼ˆç¬¬ 161-176 è¡Œï¼‰

```python
for attr_name in dir(self.cerebro):  # âš ï¸ dir() éå¸¸æ˜‚è´µï¼
    attr_val = getattr(self.cerebro, attr_name, None)
    if hasattr(attr_val, '__iter__') and not isinstance(attr_val, str):
        for item in attr_val:  # âš ï¸ åµŒå¥—å¾ªç¯
            if hasattr(item, 'lines') and hasattr(item, '_name') and hasattr(item, 'datetime'):
                # ... å¤šæ¬¡ hasattr æ£€æŸ¥
```

**æ€§èƒ½é—®é¢˜**:
1. `dir(self.cerebro)` è¿”å›å¯¹è±¡çš„æ‰€æœ‰å±æ€§åï¼ˆå¯èƒ½æ•°ç™¾ä¸ªï¼‰
2. æ¯ä¸ªå±æ€§è°ƒç”¨ `getattr()`
3. å¯¹æ¯ä¸ªå¯è¿­ä»£å±æ€§éå†æ‰€æœ‰é¡¹
4. æ¯ä¸ªé¡¹æ‰§è¡Œ 3 æ¬¡ `hasattr()` æ£€æŸ¥
5. **å¤æ‚åº¦**: O(n * m * k) å…¶ä¸­ n=å±æ€§æ•°é‡, m=å¯è¿­ä»£é¡¹æ•°é‡, k=æ£€æŸ¥æ¬¡æ•°

#### Method 2: éå†æ‰€æœ‰ argsï¼ˆç¬¬ 179-198 è¡Œï¼‰

```python
for arg in args:
    if hasattr(arg, 'lines') and hasattr(arg, '_name') and hasattr(arg, 'datetime'):
        potential_datas.append(arg)
    elif hasattr(arg, '__iter__') and not isinstance(arg, str):
        try:
            for item in arg:  # âš ï¸ åˆä¸€ä¸ªåµŒå¥—å¾ªç¯
                if hasattr(item, 'lines') and hasattr(item, '_name') and hasattr(item, 'datetime'):
                    # ... åˆæ˜¯å¤šæ¬¡æ£€æŸ¥
```

**æ€§èƒ½é—®é¢˜**:
- å†æ¬¡è¿›è¡ŒåµŒå¥—å¾ªç¯å’Œå¤šé‡æ£€æŸ¥
- å¤æ‚åº¦: O(args * items * checks)

#### Method 3: éå†è°ƒç”¨æ ˆï¼ˆç¬¬ 201-226 è¡Œï¼‰

```python
import inspect
frame = inspect.currentframe()
try:
    while frame:  # âš ï¸ éå†æ•´ä¸ªè°ƒç”¨æ ˆï¼
        frame = frame.f_back
        if frame is None:
            break
        frame_locals = frame.f_locals
        
        # Look for cerebro object with datas
        for var_name, var_value in frame_locals.items():  # âš ï¸ éå†æ¯å¸§çš„æ‰€æœ‰å±€éƒ¨å˜é‡ï¼
            if hasattr(var_value, 'datas') and hasattr(var_value, 'strategies'):
                # ...
```

**æ€§èƒ½é—®é¢˜**:
1. `inspect.currentframe()` è®¿é—®è°ƒç”¨æ ˆï¼ˆæ˜‚è´µæ“ä½œï¼‰
2. éå†æ•´ä¸ªè°ƒç”¨æ ˆï¼ˆå¯èƒ½ 10+ å¸§ï¼‰
3. æ¯å¸§éå†æ‰€æœ‰å±€éƒ¨å˜é‡
4. æ¯ä¸ªå˜é‡æ‰§è¡Œå¤šæ¬¡ `hasattr()` æ£€æŸ¥
5. **è¿™æ˜¯æœ€æ˜‚è´µçš„æ“ä½œï¼**

### å½±å“åˆ†æ

**è°ƒç”¨é¢‘ç‡**: æ¯ä¸ªç­–ç•¥åˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡
- 164 ä¸ªæµ‹è¯• Ã— å¯èƒ½å¤šä¸ªç­–ç•¥å®ä¾‹ = **æ•°ç™¾æ¬¡è°ƒç”¨**

**å•æ¬¡è€—æ—¶ä¼°ç®—**:
- Method 1: ~1-5ms
- Method 2: ~0.5-2ms  
- Method 3: ~5-20msï¼ˆæœ€æ˜‚è´µï¼ï¼‰
- **æ€»è®¡**: 7-27ms per strategy

**ç´¯è®¡å½±å“**:
- 164 ä¸ªæµ‹è¯• Ã— 15ms = **2.46 ç§’**
- å¦‚æœæ¯ä¸ªæµ‹è¯•åˆ›å»ºå¤šä¸ªç­–ç•¥: **å¯èƒ½ 5-10 ç§’ï¼**

### ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªé—®é¢˜

1. **è°ƒç”¨æ ˆéå†æ˜¯æå…¶æ˜‚è´µçš„æ“ä½œ**
   - Python çš„ `inspect` æ¨¡å—éœ€è¦è§£ææ•´ä¸ªæ ˆå¸§
   - è®¿é—® `f_locals` ä¼šå¼ºåˆ¶ Python ç‰©åŒ–å±€éƒ¨å˜é‡å­—å…¸
   - è¿™æ˜¯ Python ä¸­æœ€æ…¢çš„åå°„æ“ä½œä¹‹ä¸€

2. **dir() ä¹Ÿå¾ˆæ˜‚è´µ**
   - éœ€è¦éå†å¯¹è±¡çš„ MROï¼ˆæ–¹æ³•è§£æé¡ºåºï¼‰
   - æ”¶é›†æ‰€æœ‰å±æ€§å
   - åˆ›å»ºåˆ—è¡¨å‰¯æœ¬

3. **åµŒå¥—å¾ªç¯ + hasattr**
   - hasattr å†…éƒ¨ä½¿ç”¨ try-except
   - å¤šé‡åµŒå¥—å¯¼è‡´æŒ‡æ•°çº§å¤æ‚åº¦

4. **å®Œå…¨ä¸å¿…è¦**
   - Cerebro åº”è¯¥ç›´æ¥ä¼ é€’æ•°æ®ç»™ç­–ç•¥
   - ä¸åº”è¯¥éœ€è¦"æœç´¢"æ•°æ®æº
   - è¿™è¡¨æ˜æ•°æ®ä¼ é€’æœºåˆ¶è¢«ç ´åäº†

---

## ğŸš¨ å…³é”®æ€§èƒ½é—®é¢˜ #2: è¿‡åº¦çš„é˜²å¾¡æ€§ç¼–ç¨‹

### é—®é¢˜ä½ç½®
æ•´ä¸ª `strategy.py` æ–‡ä»¶

### é—®é¢˜æè¿°

ä»£ç ä¸­å……æ»¡äº†è¿‡åº¦çš„é˜²å¾¡æ€§æ£€æŸ¥ï¼š

```python
# ç¬¬ 234-241 è¡Œ
if self.datas:
    self.data = self.datas[0]
    for d, data in enumerate(self.datas):
        setattr(self, f"data{d}", data)  # âš ï¸ åŠ¨æ€ setattr å¾ˆæ…¢
        # print(f"Strategy.__init__: Set primary data and aliases for {len(self.datas)} datas")
else:
    self.data = None
```

**æ€§èƒ½é—®é¢˜**:
- `setattr()` æ¯”ç›´æ¥èµ‹å€¼æ…¢
- f-string æ ¼å¼åŒ–ï¼ˆå³ä½¿æ³¨é‡Šäº†ä¹Ÿåœ¨å¾ªç¯ä¸­ï¼‰
- ä¸å¿…è¦çš„æ¡ä»¶æ£€æŸ¥

---

## ğŸš¨ å…³é”®æ€§èƒ½é—®é¢˜ #3: _oncepost ä¸­çš„é‡å¤ç´¢å¼•è®¾ç½®

### é—®é¢˜ä½ç½®  
`backtrader/strategy.py` ç¬¬ 607-652 è¡Œï¼ˆå·²éƒ¨åˆ†ä¼˜åŒ–ï¼‰

### é—®é¢˜æè¿°

è™½ç„¶æˆ‘ä»¬å·²ç»ä¼˜åŒ–äº†å±æ€§è®¿é—®ï¼Œä½†ä»å­˜åœ¨é—®é¢˜ï¼š

```python
# Set _idx for data feeds
if self.datas:
    for data in self.datas:
        try:
            if hasattr(data, 'array'):
                data_len = len(data.array)
                # ... è®¡ç®— _idx
                
            # Set _idx for data lines
            if hasattr(data, 'lines'):
                data_lines = data.lines
                if hasattr(data_lines, 'lines'):
                    for line in data_lines.lines:  # âš ï¸ ä¸ºæ¯ä¸ª line è®¾ç½® _idx
                        line._idx = current_idx
```

**è°ƒç”¨é¢‘ç‡**: ~42,000 æ¬¡ï¼ˆ164 æµ‹è¯• Ã— ~256 barsï¼‰

**é—®é¢˜**:
- æ¯æ¬¡è°ƒç”¨éƒ½è®¾ç½®æ‰€æœ‰ data lines çš„ _idx
- å³ä½¿ _idx æ²¡æœ‰æ”¹å˜ä¹Ÿä¼šè®¾ç½®
- å¦‚æœæœ‰ 5 æ¡ line Ã— 42,000 æ¬¡ = **210,000 æ¬¡èµ‹å€¼**

---

## ğŸš¨ å…³é”®æ€§èƒ½é—®é¢˜ #4: æŒ‡æ ‡åˆ›å»ºæ—¶çš„é€’å½’æœç´¢

### é—®é¢˜ä½ç½®
`backtrader/lineiterator.py` ç¬¬ 1700+ è¡Œ

### å¯èƒ½çš„é—®é¢˜

ä»ä¹‹å‰çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œç­–ç•¥åˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºæŒ‡æ ‡ï¼Œè€ŒæŒ‡æ ‡åˆ›å»ºå¯èƒ½ä¹Ÿæ¶‰åŠç±»ä¼¼çš„æœç´¢é€»è¾‘ã€‚

---

## ğŸ“Š æ€§èƒ½å½±å“ä¼°ç®—

### ç´¯è®¡æ—¶é—´æµªè´¹

| æ€§èƒ½é—®é¢˜ | å•æ¬¡è€—æ—¶ | è°ƒç”¨é¢‘ç‡ | ç´¯è®¡å½±å“ |
|---------|---------|---------|---------|
| Strategy æœç´¢é€»è¾‘ | 7-27ms | 164+ æ¬¡ | **1.1-4.4 ç§’** |
| _oncepost _idx è®¾ç½® | å¾®ç§’çº§ | 42,000 æ¬¡ | **1-2 ç§’** |
| è¿‡åº¦çš„ hasattr | å¾®ç§’çº§ | æ•°åä¸‡æ¬¡ | **2-3 ç§’** |
| è°ƒç”¨æ ˆéå† | 5-20ms | 164+ æ¬¡ | **0.8-3.3 ç§’** |
| **æ€»è®¡** | - | - | **5-13 ç§’** |

**è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆæ€§èƒ½ä¸‹é™äº†ï¼**

ä» 237 ç§’é™ä½ 5-13 ç§’åï¼Œåº”è¯¥æ˜¯ **224-232 ç§’**ï¼Œä½†å®é™…å¯èƒ½æ›´ç³Ÿï¼Œå› ä¸ºï¼š
- å¤šä¸ªç­–ç•¥å®ä¾‹
- ä¼˜åŒ–æµ‹è¯•æ—¶çš„é¢å¤–å¼€é”€
- å…¶ä»–æœªå‘ç°çš„é—®é¢˜

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### ä¸ºä»€ä¹ˆä¼šæœ‰è¿™äº›é—®é¢˜ï¼Ÿ

#### 1. å…ƒç±»ç§»é™¤çš„å‰¯ä½œç”¨

åœ¨ master åˆ†æ”¯ï¼Œå¯èƒ½æ˜¯è¿™æ ·çš„ï¼š
```python
# Master åˆ†æ”¯ï¼ˆä½¿ç”¨å…ƒç±»ï¼‰
class Strategy(metaclass=MetaStrategy):
    # å…ƒç±»è‡ªåŠ¨å¤„ç†æ•°æ®åˆ†é…
    pass
```

åœ¨ remove-metaprogramming åˆ†æ”¯ï¼š
```python
# Remove åˆ†æ”¯ï¼ˆæ‰‹åŠ¨å¤„ç†ï¼‰
class Strategy:
    def __init__(self):
        # æ‰‹åŠ¨æœç´¢æ•°æ®æº ğŸ˜±
        # å› ä¸ºä¸çŸ¥é“å¦‚ä½•æ­£ç¡®ä¼ é€’
        for attr_name in dir(self.cerebro):  # ç¾éš¾å¼€å§‹...
```

#### 2. æ•°æ®ä¼ é€’æœºåˆ¶è¢«ç ´å

**æ­£ç¡®çš„æ–¹å¼**:
```python
# Cerebro åº”è¯¥æ˜¾å¼ä¼ é€’æ•°æ®
strategy = Strategy(datas=self.datas, broker=self.broker)
```

**å½“å‰çš„æ–¹å¼**:
```python
# ç­–ç•¥ä¸çŸ¥é“æ•°æ®åœ¨å“ªé‡Œï¼Œåªèƒ½"æœç´¢"
strategy = Strategy()  # æ•°æ®å‘¢ï¼Ÿï¼Ÿ
# Strategy.__init__ å¼€å§‹ç–¯ç‹‚æœç´¢...
```

#### 3. è¿‡åº¦è¡¥å¿

ä¸ºäº†å¼¥è¡¥å…ƒç±»ç§»é™¤åçš„åŠŸèƒ½ç¼ºå¤±ï¼Œä»£ç é‡‡å–äº†ï¼š
- æš´åŠ›æœç´¢
- é˜²å¾¡æ€§ç¼–ç¨‹
- è¿‡åº¦çš„é”™è¯¯å¤„ç†
- å¤§é‡çš„ hasattr/getattr è°ƒç”¨

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®

### ä¼˜å…ˆçº§ 1: ä¿®å¤æ•°æ®ä¼ é€’æœºåˆ¶

**å½“å‰ï¼ˆé”™è¯¯ï¼‰**:
```python
# strategy.py __init__
if not hasattr(self, 'datas') or not self.datas:
    # å¼€å§‹ç–¯ç‹‚æœç´¢...
```

**åº”è¯¥æ”¹ä¸º**:
```python
def __init__(self, datas=None, broker=None, **kwargs):
    """Proper data assignment during initialization"""
    self.datas = datas if datas is not None else []
    self.broker = broker
    # ä¸éœ€è¦æœç´¢ï¼
```

**Cerebro ç«¯**:
```python
# cerebro.py
def _runstrats(self):
    for stratcls in self.strategies:
        # æ˜¾å¼ä¼ é€’æ•°æ®
        strat = stratcls(datas=self.datas, broker=self.broker)
```

**é¢„æœŸæå‡**: **5-10 ç§’**

### ä¼˜å…ˆçº§ 2: ç§»é™¤è°ƒç”¨æ ˆéå†

```python
# å®Œå…¨åˆ é™¤ Method 3ï¼ˆç¬¬ 201-226 è¡Œï¼‰
# å¦‚æœå‰ä¸¤ä¸ªæ–¹æ³•éƒ½å¤±è´¥äº†ï¼Œç›´æ¥ä½¿ç”¨ç©ºåˆ—è¡¨
# ä¸è¦éå†è°ƒç”¨æ ˆï¼
```

**é¢„æœŸæå‡**: **0.8-3.3 ç§’**

### ä¼˜å…ˆçº§ 3: ä¼˜åŒ– dir() ä½¿ç”¨

```python
# ä¸è¦ä½¿ç”¨ dir()
# å¦‚æœå¿…é¡»æœç´¢ï¼Œä½¿ç”¨ __dict__ 
for attr_name in self.cerebro.__dict__:  # æ›´å¿«
    # ...
```

**é¢„æœŸæå‡**: **0.5-1 ç§’**

### ä¼˜å…ˆçº§ 4: ç¼“å­˜ _idx è®¾ç½®

```python
# _oncepost ä¸­
# åªåœ¨ _idx æ”¹å˜æ—¶æ‰è®¾ç½®
if data._last_idx != current_idx:
    data._idx = current_idx
    data._last_idx = current_idx
```

**é¢„æœŸæå‡**: **1-2 ç§’**

---

## ğŸ¯ æ€»ä½“ä¼˜åŒ–æ½œåŠ›

| ä¼˜åŒ–é¡¹ | é¢„æœŸæå‡ | éš¾åº¦ |
|--------|---------|------|
| ä¿®å¤æ•°æ®ä¼ é€’ | 5-10 ç§’ | ä¸­ |
| ç§»é™¤æ ˆéå† | 0.8-3.3 ç§’ | æ˜“ |
| ä¼˜åŒ– dir() | 0.5-1 ç§’ | æ˜“ |
| ç¼“å­˜ _idx | 1-2 ç§’ | æ˜“ |
| **æ€»è®¡** | **7-16 ç§’** | - |

**ä» 237 ç§’ä¼˜åŒ–åˆ° 220-230 ç§’å**ï¼Œå†ä¼˜åŒ– **7-16 ç§’**ï¼š
- **æœ€ç»ˆé¢„æœŸ**: **204-223 ç§’**
- **æ€»æå‡**: **14-33 ç§’ï¼ˆ6-14%ï¼‰**

**åŠ ä¸Šä¹‹å‰çš„ä¼˜åŒ–ï¼ˆ20-22%ï¼‰**ï¼š
- **ç´¯è®¡æå‡**: **26-36%**
- **æœ€ç»ˆæ—¶é—´**: **151-180 ç§’**

---

## ğŸ”¬ éªŒè¯æ–¹æ³•

### 1. æ·»åŠ æ€§èƒ½è®¡æ—¶

```python
import time

# Strategy.__init__
def __init__(self, *args, **kwargs):
    start = time.time()
    
    # Method 1
    method1_start = time.time()
    # ... Method 1 code ...
    method1_time = time.time() - method1_start
    
    # Method 2
    method2_start = time.time()
    # ... Method 2 code ...
    method2_time = time.time() - method2_start
    
    # Method 3  
    method3_start = time.time()
    # ... Method 3 code ...
    method3_time = time.time() - method3_start
    
    total_time = time.time() - start
    
    # Log timing
    if total_time > 0.005:  # å¦‚æœè¶…è¿‡ 5ms
        print(f"âš ï¸  Strategy.__init__ took {total_time*1000:.2f}ms")
        print(f"   Method1: {method1_time*1000:.2f}ms")
        print(f"   Method2: {method2_time*1000:.2f}ms")
        print(f"   Method3: {method3_time*1000:.2f}ms")
```

### 2. ä½¿ç”¨ cProfile

```bash
python -m cProfile -o profile.stats -m pytest tests/add_tests/test_strategy.py
python -c "import pstats; p = pstats.Stats('profile.stats'); p.sort_stats('cumulative').print_stats(30)"
```

### 3. å¯¹æ¯” master åˆ†æ”¯

```bash
# åœ¨ master åˆ†æ”¯
git checkout master
python run_selected_tests.py

# åœ¨ remove åˆ†æ”¯  
git checkout remove-metaprogramming
python run_selected_tests.py

# å¯¹æ¯”æ—¶é—´
```

---

## ğŸ“ ç»“è®º

**å‘ç°çš„æ ¸å¿ƒé—®é¢˜**:

1. ğŸš¨ **Strategy.__init__ çš„æš´åŠ›æœç´¢é€»è¾‘** - æœ€ä¸¥é‡
2. ğŸš¨ **è°ƒç”¨æ ˆéå†** - æå…¶æ˜‚è´µ
3. âš ï¸  **è¿‡åº¦çš„ hasattr/getattr** - ç´¯ç§¯å½±å“å¤§
4. âš ï¸  **æ•°æ®ä¼ é€’æœºåˆ¶è¢«ç ´å** - æ ¹æœ¬åŸå› 

**æ€§èƒ½å½±å“**: **7-16 ç§’çš„é¢å¤–å¼€é”€**

**è§£å†³æ–¹æ¡ˆ**: 
- ä¿®å¤ Cerebro â†’ Strategy çš„æ•°æ®ä¼ é€’
- ç§»é™¤æ‰€æœ‰æš´åŠ›æœç´¢é€»è¾‘
- ä½¿ç”¨æ˜¾å¼å‚æ•°ä¼ é€’

**é¢„æœŸæ•ˆæœ**: 
- æ¶ˆé™¤ 7-16 ç§’å¼€é”€
- ç»“åˆä¹‹å‰ä¼˜åŒ–ï¼Œæ€»æå‡ **26-36%**
- æœ€ç»ˆæ—¶é—´: **151-180 ç§’**

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-10-26  
**ä¸‹ä¸€æ­¥**: å®æ–½ä¿®å¤æ–¹æ¡ˆ

