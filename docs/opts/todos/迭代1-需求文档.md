# 迭代1: 修复test_02测试用例跨平台不一致问题

## 1. 问题背景

### 1.1 现象描述
- **Mac环境**: master分支和remove-metaprogramming分支的测试结果都是**通过**的
- **Ubuntu环境**: remove-metaprogramming分支的测试结果是**失败**的

### 1.2 具体差异

| 指标 | Mac结果 | Ubuntu结果 |
|------|---------|------------|
| bar_num | 1885 | 1885 |
| trade_num | **1749** | **1750** |
| sharpe_ratio | 0.4613345781810348 | 0.46882103593170665 |
| annual_return | 0.055969750235917486 | 0.056615798284517765 |
| max_drawdown | 0.23776639938068544 | 0.24142378277185714 |

### 1.3 断言失败
```python
assert trade_num == 1749  # Ubuntu上trade_num=1750，导致失败
```

## 2. 需求目标

1. **确保测试用例在Mac和Ubuntu上产生一致的结果**
2. 不改变策略的核心逻辑
3. 保持测试的有效性和可重复性

## 3. 问题根因分析

通过对比Mac和Ubuntu的运行日志，发现以下差异：

### 3.1 交易顺序不同
在相同日期，买卖操作的顺序在两个平台上有细微差异。例如在2018-02-01的买入操作中：
- **Mac**: 110032 (125.55) 排在 110033 (123.6) 之前
- **Ubuntu**: 110033 (123.6) 排在 110032 (125.55) 之前

### 3.2 根本原因
代码中存在以下**非确定性排序**问题：

1. **`df.groupby("symbol")`** (第202行): 
   - groupby的迭代顺序在不同平台/Python版本可能不同

2. **`df["close_score"].rank(method="first")`** (第408行):
   - 当有相同值时，`method="first"`使用数据出现的顺序，这取决于输入顺序

3. **`df.sort_values(by=["total_score"])`** (第416行):
   - 当total_score相同时，排序结果不稳定

4. **`self.stock_dict`字典遍历** (第391行):
   - 虽然Python 3.7+字典保持插入顺序，但不同平台插入顺序可能不同

## 4. 验收标准

1. 测试用例在Mac和Ubuntu上都能通过
2. 两个平台产生完全相同的回测结果
3. 代码修改最小化，不影响策略逻辑
