### 背景

重构代码之后，这个测试用例失败了，需要修复这个测试用例，分析定位bug在什么地方，然后修复

优先修复这两个失败的测试用例： FAILED tests/add_tests/test_line_operations.py::test_keltner_line_operations - AssertionError: First upper_line mismatch: expected 105.875734, got 99.783775
FAILED tests/add_tests/test_line_operations.py::test_run - AssertionError: First upper_line mismatch: expected 105.875734, got 99.783775

------------------------------------------------------------
Passed:       423
Failed:       29
Timeout:      0
------------------------------------------------------------
Status:       ❌ SOME TESTS FAILED

============================================================
Failed Tests:
============================================================
  FAILED tests/add_tests/test_line_operations.py::test_keltner_line_operations - AssertionError: First upper_line mismatch: expected 105.875734, got 99.783775
  FAILED tests/add_tests/test_line_operations.py::test_run - AssertionError: First upper_line mismatch: expected 105.875734, got 99.783775
  FAILED tests/strategies/test_104_cci_strategy.py::test_cci_strategy - AssertionError: Expected bar_num=1219, got 1238
  FAILED tests/strategies/test_108_keltner_channel_strategy.py::test_keltner_channel_strategy - AssertionError: Expected final_value=100039.51, got 100219.86669999998
  FAILED tests/strategies/test_105_donchian_channel_strategy.py::test_donchian_channel_strategy - AssertionError: Expected final_value=99965.62, got 99983.54054995005
  FAILED tests/strategies/test_109_ultimate_oscillator_strategy.py::test_ultimate_oscillator_strategy - AssertionError: Expected bar_num=1229, got 1230
  FAILED tests/strategies/test_103_stochastic_strategy.py::test_stochastic_strategy - AssertionError: Expected bar_num=1239, got 1244
  FAILED tests/strategies/test_117_price_channel_strategy.py::test_price_channel_strategy - AssertionError: Expected final_value=100050.36, got 100047.69622998998
  FAILED tests/strategies/test_114_supertrend_rsi_strategy.py::test_supertrend_rsi_strategy - AssertionError: Expected final_value=100085.04, got 99930.34609970017
  FAILED tests/strategies/test_36_macd_atr_strategy.py::test_macd_atr_strategy - AssertionError: Expected buy_count=46, got 63
  FAILED tests/strategies/test_44_signals_strategy.py::test_signals_strategy - AssertionError: Expected total_trades=21, got 0
  FAILED tests/strategies/test_32_stochastic_sr_strategy.py::test_stochastic_sr_strategy - AssertionError: Expected bar_num=5398, got 5402
  FAILED tests/strategies/test_58_data_replay.py::test_data_replay - AssertionError: Expected final_value=108263.90, got 107605.40000000001
  FAILED tests/strategies/test_66_donchian_channel_strategy.py::test_donchian_channel_strategy - AssertionError: Expected final_value=100000.0, got 100219.86669999998
  FAILED tests/strategies/test_75_extended_cross_strategy.py::test_extended_cross_strategy - AssertionError: Expected final_value=99898.01, got 100008.76566983004
  FAILED tests/strategies/test_64_atr_momentum_strategy.py::test_atr_momentum_strategy - AssertionError: Expected final_value=99399.52, got 84865.20999999992
  FAILED tests/strategies/test_70_keltner_channel_strategy.py::test_keltner_channel_strategy - AssertionError: Expected final_value=100039.51, got 100219.86669999998
  FAILED tests/strategies/test_81_supertrend_strategy.py::test_supertrend_strategy - AssertionError: Expected final_value=99999.23, got 100014.55017979996
  FAILED tests/strategies/test_82_alligator_strategy.py::test_alligator_strategy - AssertionError: Expected final_value=100011.2, got 100203.75058999
  FAILED tests/strategies/test_78_percent_rank_strategy.py::test_percent_rank_strategy - AssertionError: Expected bar_num=3548, got 3573
  FAILED tests/strategies/test_84_arjun_bhatia_futures_strategy.py::test_arjun_bhatia_futures_strategy - AssertionError: Expected final_value=100008.3, got 99810.72285962013
  FAILED tests/strategies/test_89_adaptive_supertrend_strategy.py::test_adaptive_supertrend_strategy - AssertionError: Expected bar_num=1218, got 1237
  FAILED tests/strategies/test_94_mean_reversion_sma_strategy.py::test_mean_reversion_sma_strategy - AssertionError: Expected final_value=172375.61, got 158319.837331632
  FAILED tests/strategies/test_111_chandelier_exit_strategy.py::test_chandelier_exit_strategy - AssertionError: Expected final_value=100018.36, got 100212.05888999
  FAILED tests/strategies/test_88_supertrend_indicator_strategy.py::test_supertrend_indicator_strategy - AssertionError: Expected final_value=99977.89, got 99948.3434197802
  FAILED tests/strategies/test_96_ichimoku_cloud_strategy.py::test_ichimoku_cloud_strategy - AssertionError: Expected bar_num=1180, got 1206
  FAILED tests/strategies/test_08_kelter_strategy.py::test_keltner_strategy - AssertionError: Expected sharpe_ratio=-0.7248889123130405, got -3.922671007...
  FAILED tests/strategies/test_86_sunrise_ema_crossover_strategy.py::test_sunrise_volatility_expansion_strategy - AssertionError: Expected final_value=99780.54, got 100000.0
  FAILED tests/strategies/test_93_macd_dmi_simple_strategy.py::test_macd_dmi_simple_strategy - ZeroDivisionError: float division by zero

### 修复方法建议
1. backtrader/run_test_with_log.py 这个运行这个策略，然后对比master分支上的结果，看看origin分支上的结果究竟差在哪里，然后去定位。
2. 如果必要，可以修改测试用例，增加注释，然后方便在两个分支上进行对比。

### 限制

1. 不允许修改测试用例，尤其是测试用例的期望值。
2. 修改过源代码重新测试的时候，最好pip install -U . 重新安装一下。