### 背景

重构代码之后，这个测试用例失败了，需要修复这个测试用例，分析定位bug在什么地方，然后修复

从失败的测试用例看，
tests/original_tests/test_strategy_optimized.py，
tests/strategies/test_21_the_strategy.py，
tests/strategies/test_31_bb_adx_strategy.py，
tests/strategies/test_35_sma_cross_signal_strategy.py
tests/strategies/test_36_macd_atr_strategy.py

这几个都是买卖信号的问题，需要考虑crossover和sma指标是否设置正确了，从个人经验来看，应该是指标的问题

============================================================
Failed Tests:
============================================================
  FAILED tests/original_tests/test_strategy_optimized.py::test_run - AssertionError: assert ['14525.80', ...4763.90', ...] == ['14485.10', ...47...
  FAILED tests/strategies/test_21_the_strategy.py::test_ema_cross_strategy - AssertionError: Expected bar_num=1780, got 55
  FAILED tests/strategies/test_31_bb_adx_strategy.py::test_bb_adx_strategy - AssertionError: Expected buy_count=296, got 316
  FAILED tests/strategies/test_48_strategy_selection.py::test_strategy_selection - AssertionError: Expected final_value_b=105258.30, got 105508.4
  FAILED tests/strategies/test_35_sma_cross_signal_strategy.py::test_sma_cross_signal_strategy - AssertionError: Expected buy_count=14, got 13
  FAILED tests/strategies/test_81_supertrend_strategy.py::test_supertrend_strategy - AssertionError: Expected final_value near 99999.23, got 99984.74537001003
  FAILED tests/strategies/test_89_adaptive_supertrend_strategy.py::test_adaptive_supertrend_strategy - AssertionError: Expected final_value near 99936.86, got 99947.58428991005
  FAILED tests/strategies/test_36_macd_atr_strategy.py::test_macd_atr_strategy - AssertionError: Expected buy_count=46, got 31
  FAILED tests/strategies/test_17_cb_monday_strategy.py::test_cb_friday_rotation_strategy - AssertionError: Expected final_value=1039666.6544150009, got 1039666.654415...
============================================================

### 修复方法建议
1. backtrader/run_test_with_log.py 这个运行这个策略，然后对比master分支上的结果，看看origin分支上的结果究竟差在哪里，然后去定位。
2. 如果必要，可以为测试用例增加日志输出，然后方便在两个分支上进行对比。
3. 现在有多个测试用例失败，每次修改之后，pip install -U . 重新安装一下，然后可以考虑运行
bash run_tests_clean.sh 分析现在测试用例有哪些成功，哪些失败。

### 限制

1. 不允许修改测试用例，尤其是测试用例的期望值。尤其是这一点需要注意，这个是master分支的版本是可以通过的，所以很大可能是现在分支的代码存在问题，如果你认真对比分析之后，发现是master版本的代码出错了，你也可以提出来，放到最后面，后面我确认之后，去修复master的问题。
2. 修改过源代码重新测试的时候，最好pip install -U . 重新安装一下。
3. 现在版本的代码和原始的底层实现的逻辑已经有很大不一样了，每个函数的逻辑可能会存在不一样，不能按照master版本的相应函数来实现现在版本的函数。即不允许：restore the master branch's simpler, declarative implementation