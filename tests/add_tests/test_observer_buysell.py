#!/usr/bin/env python
"""Test module for the BuySell observer in backtrader.

This module contains tests to verify that the BuySell observer correctly tracks
and displays buy and sell signals generated by a trading strategy. The test
strategy uses a Simple Moving Average (SMA) crossover system to generate
trading signals.

Example:
    Run the test directly with plotting:
    >>> python test_observer_buysell.py

    Run the test without plotting (typical for pytest):
    >>> pytest tests/add_tests/test_observer_buysell.py
"""

import backtrader as bt

from . import testcommon


class RunStrategy(bt.Strategy):
    """A simple moving average crossover trading strategy.

    This strategy generates buy signals when the price crosses above the
    SMA and closes positions when the price crosses below the SMA. It also
    includes a BuySell observer to track and display these trading signals.

    Attributes:
        sma: Simple Moving Average indicator with period of 15 bars.
        cross: CrossOver indicator that tracks when price crosses the SMA.
    """

    def __init__(self):
        """Initialize the strategy with indicators and observer.

        Creates:
            - SMA indicator with 15-period window
            - CrossOver indicator to detect price/SMA crossovers
            - BuySell observer to visualize buy/sell signals
        """
        self.sma = bt.indicators.SMA(self.data, period=15)
        self.cross = bt.indicators.CrossOver(self.data.close, self.sma)
        # Add BuySell observer to track buy and sell signals
        bt.observers.BuySell(self.data)

    def next(self):
        """Execute trading logic for each bar.

        Trading rules:
            - Enter long position when price crosses above SMA (cross > 0)
            - Close position when price crosses below SMA (cross < 0)
            - Only enter new positions if not already in a position
        """
        if not self.position.size:
            if self.cross > 0.0:
                self.buy()
        elif self.cross < 0.0:
            self.close()


def test_run(main=False):
    """Run the BuySell observer test.

    This function creates a cerebro instance, adds test data, runs the
    RunStrategy, and verifies that the BuySell observer correctly captures
    the buy and sell signals generated by the strategy.

    Args:
        main (bool, optional): If True, enables plotting mode. If False,
            runs in test mode without plotting. Defaults to False.

    Returns:
        None: This function performs assertions but does not return a value.

    Raises:
        AssertionError: If the strategy did not run (len(strat) == 0).
    """
    datas = [testcommon.getdata(0)]
    cerebros = testcommon.runtest(datas, RunStrategy, plot=main)

    for cerebro in cerebros:
        strat = cerebro.runstrats[0][0]
        if main:
            # print('BuySell observer test completed')  # Removed for performance
            pass
        # Verify the strategy ran successfully
        assert len(strat) > 0


if __name__ == "__main__":
    test_run(main=True)
