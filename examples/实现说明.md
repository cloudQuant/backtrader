# 可转债溢价率均线交叉策略实现说明

## 任务完成情况

### 1. 数据清洗 ✅

**脚本文件**: `clean_bond_data.py`

**功能**:
- 从 `bond_merged_all_data.csv` 中读取所有可转债数据
- 统计每个可转债的交易天数
- 找出交易天数最多的可转债（代码: 113013）
- 将该可转债的数据保存为 `113013.csv`

**结果**:
- 找到的可转债代码: **113013**
- 交易天数: **1444天**
- 数据日期范围: 2017-07-24 到 2023-07-03

### 2. 策略实现 ✅

**脚本文件**: `premium_rate_crossover_strategy.py`

**策略逻辑**:
1. 使用转股溢价率（convert_premium_rate）作为信号源
2. 计算10日移动平均线（短期均线）
3. 计算60日移动平均线（长期均线）
4. **买入信号**: 当短期均线上穿长期均线时（金叉）
5. **卖出信号**: 当短期均线下穿长期均线时（死叉）

**参考文件**:
- `examples/sma_crossover.py`: 使用了相同的均线交叉逻辑
- `examples/优化策略1.py`: 参考了数据加载、策略结构和分析器设置

**关键特性**:
- 使用 `ExtendPandasFeed` 扩展数据源，支持可转债特有字段
- 使用 backtrader 的 `CrossOver` 指标检测均线交叉
- 使用 `SimpleMovingAverage` 计算移动平均线
- 完整的订单和交易通知处理
- 多种分析器：夏普比率、收益率、回撤、交易分析

## 回测结果

**回测参数**:
- 初始资金: 100,000 元
- 手续费率: 0.03%
- 可转债: 113013
- 数据范围: 2017-07-24 至 2023-07-03

**回测结果**:
- 最终资金: 104,275.87 元
- 总收益: 4,275.87 元
- 收益率: **4.28%**
- 年化收益率: **0.73%**
- 夏普比率: 0.14
- 最大回撤: **17.41%**
- 总交易次数: 21次

**交易统计**:
- 回测期间共进行了21次完整交易
- 策略在多个时间点捕捉到了金叉和死叉信号
- 从日志可以看出策略成功识别了市场趋势变化

## 文件说明

### 生成的文件

1. **113013.csv** - 清洗后的可转债数据
   - 包含1444条交易记录
   - 字段: 开盘价、收盘价、最高价、最低价、成交量、纯债价值、转股价值、纯债溢价率、转股溢价率

2. **113013_strategy_result.png** - 策略回测结果图表
   - 包含两个子图:
     - 资产曲线图
     - 累计收益率图

### 代码文件

1. **clean_bond_data.py** - 数据清洗脚本
   - 独立运行，生成清洗后的数据文件

2. **premium_rate_crossover_strategy.py** - 策略实现脚本
   - 包含完整的策略逻辑
   - 包含回测和可视化功能
   - 可独立运行

## 使用方法

### 1. 清洗数据
```bash
python clean_bond_data.py
```

### 2. 运行策略回测
```bash
python premium_rate_crossover_strategy.py
```

## 策略优化建议

基于回测结果，以下是一些可能的优化方向:

1. **参数优化**: 可以尝试不同的均线周期组合（如5/20, 20/120等）
2. **止损止盈**: 增加止损和止盈机制，控制单笔交易的风险
3. **仓位管理**: 根据信号强度动态调整仓位
4. **过滤条件**: 增加额外的过滤条件，如成交量、溢价率阈值等
5. **多标的**: 扩展到多个可转债，构建投资组合

## 技术要点

### 扩展数据源
```python
class ExtendPandasFeed(bt.feeds.PandasData):
    params = (
        ('datetime', None),
        ('open', 0),
        ('high', 1),
        ('low', 2),
        ('close', 3),
        ('volume', 4),
        ('openinterest', -1),
        ('pure_bond_value', 5),
        ('convert_value', 6),
        ('pure_bond_premium_rate', 7),
        ('convert_premium_rate', 8)
    )
    lines = ('pure_bond_value', 'convert_value', 'pure_bond_premium_rate', 'convert_premium_rate')
```

### 均线交叉检测
```python
# 计算移动平均线
self.sma_short = btind.SimpleMovingAverage(self.premium_rate, period=10)
self.sma_long = btind.SimpleMovingAverage(self.premium_rate, period=60)

# 检测交叉
self.crossover = btind.CrossOver(self.sma_short, self.sma_long)

# 在next()中判断
if self.crossover > 0:  # 金叉
    self.buy()
elif self.crossover < 0:  # 死叉
    self.close()
```

## 总结

本次实现完成了以下工作:
1. ✅ 从海量数据中筛选出最适合回测的可转债
2. ✅ 实现了基于溢价率均线的金叉死叉策略
3. ✅ 完成了完整的回测和结果可视化
4. ✅ 提供了详细的交易日志和性能指标

策略代码结构清晰，易于理解和修改，可以作为进一步优化和扩展的基础。

