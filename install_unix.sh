#!/bin/bash

# Set path variables
BACKTRADER_PATH="./backtrader"
BUILD_DIR="build"
EGG_INFO_DIR="backtrader.egg-info"
BENCHMARKS_DIR=".benchmarks"
PYFOLIO_VERSION="0.9.6"

# 切换到上一级目录
echo "Switching to the parent directory..."
cd ..

# Function to check if a Python package is installed
check_package_installed() {
    python3 -c "import pkgutil; exit(0 if pkgutil.find_loader('$1') is not None else 1)"
}

# 检查 pyfolio 0.9.6 版本是否已经安装
echo "Checking if pyfolio $PYFOLIO_VERSION is installed..."
if ! check_package_installed "pyfolio"; then
    echo "pyfolio $PYFOLIO_VERSION not found."

    # 检查当前目录下是否存在 pyfolio 文件夹
    if [ ! -d "pyfolio" ]; then
        echo "pyfolio directory does not exist. Cloning pyfolio from Gitee..."
        git clone https://gitee.com/yunjinqi/pyfolio
        if [ $? -ne 0 ]; then
            echo "Failed to clone pyfolio repository. Exiting..."
            exit 1
        fi
    else
        echo "pyfolio directory already exists. Skipping git clone."
    fi

    # 运行 install_unix.sh 安装 pyfolio
    echo "Running install_unix.sh for pyfolio..."
    sh ./pyfolio/install_unix.sh
    if [ $? -ne 0 ]; then
        echo "Failed to run install_unix.sh for pyfolio. Exiting..."
        exit 1
    fi
    cd ..
else
    echo "pyfolio $PYFOLIO_VERSION is already installed."
fi

# Function to handle errors
handle_error() {
    echo "$1"
    exit 1
}

# Install dependencies from requirements.txt
echo "Installing dependencies from requirements.txt..."
# pip install -U -r requirements.txt
if [ $? -ne 0 ]; then
    handle_error "Failed to install dependencies. Please check the requirements.txt file."
fi

echo "git pull new code"
git pull
# Switch to the parent directory
echo "Switching to the parent directory..."
cd ..
if [ $? -ne 0 ]; then
    handle_error "Failed to switch directory."
fi

# Install the backtrader package
echo "Installing the backtrader package..."
pip install -U --no-build-isolation "$BACKTRADER_PATH"
if [ $? -ne 0 ]; then
    handle_error "Failed to install the backtrader package."
fi

# Delete intermediate build and egg-info directories
echo "Deleting intermediate files..."
cd backtrader
if [ -d "$BUILD_DIR" ]; then
    rm -rf "$BUILD_DIR"
    echo "Deleted $BUILD_DIR directory."
fi
if [ -d "$EGG_INFO_DIR" ]; then
    rm -rf "$EGG_INFO_DIR"
    echo "Deleted $EGG_INFO_DIR directory."
fi

# Run backtrader tests with 4 parallel processes
echo "Running backtrader tests..."
# pytest --ignore=tests/crypto_tests tests -n 8
# python tests/crypto_tests/test_data_strategy.py
# python tests/crypto_tests/test_binance_ma.py
if [ $? -ne 0 ]; then
    handle_error "Test cases failed."
fi

# Delete the .benchmarks directory generated by pytest
if [ -d "$BENCHMARKS_DIR" ]; then
    rm -rf "$BENCHMARKS_DIR"
    echo "Deleted $BENCHMARKS_DIR directory."
fi

# Delete all .log files
echo "Deleting all .log files..."
find . -type f -name "*.log" -exec rm -f {} \;
echo "All .log files deleted."

# Script completed
echo "Script execution completed!"


