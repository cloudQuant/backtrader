#!/bin/bash

# Set path variables
BACKTRADER_PATH="./backtrader"
BUILD_DIR="build"
EGG_INFO_DIR="backtrader.egg-info"
BENCHMARKS_DIR=".benchmarks"

# Function to handle errors
handle_error() {
    echo "$1"
    exit 1
}

# Install dependencies from requirements.txt
echo "Installing dependencies from requirements.txt..."
# pip install -U -r requirements.txt
if [ $? -ne 0 ]; then
    handle_error "Failed to install dependencies. Please check the requirements.txt file."
fi

# Switch to the parent directory
echo "Switching to the parent directory..."
cd ..
if [ $? -ne 0 ]; then
    handle_error "Failed to switch directory."
fi

# Install the backtrader package
echo "Installing the backtrader package..."
pip install -U --no-build-isolation "$BACKTRADER_PATH"
if [ $? -ne 0 ]; then
    handle_error "Failed to install the backtrader package."
fi

# Delete intermediate build and egg-info directories
echo "Deleting intermediate files..."
cd backtrader
if [ -d "$BUILD_DIR" ]; then
    rm -rf "$BUILD_DIR"
    echo "Deleted $BUILD_DIR directory."
fi
if [ -d "$EGG_INFO_DIR" ]; then
    rm -rf "$EGG_INFO_DIR"
    echo "Deleted $EGG_INFO_DIR directory."
fi

# Run backtrader tests with 4 parallel processes
echo "Running backtrader tests..."
# pytest tests -n 4
python tests/crypto_tests/test_binance_ma.py
if [ $? -ne 0 ]; then
    handle_error "Test cases failed."
fi

# Delete the .benchmarks directory generated by pytest
if [ -d "$BENCHMARKS_DIR" ]; then
    rm -rf "$BENCHMARKS_DIR"
    echo "Deleted $BENCHMARKS_DIR directory."
fi

# Script completed
echo "Script execution completed!"

